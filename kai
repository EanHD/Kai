#!/bin/bash
# Kai CLI entry point with dependency checks

# Get absolute path to script directory (project root)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" || exit 1

# Change to project root
cd "$SCRIPT_DIR" || exit 1

# Check if we have a virtual environment
if [ -d ".venv" ]; then
    echo "üîç Using existing virtual environment"
    source .venv/bin/activate
    
    # Check Python version and executable
    echo "   Python: $(python --version 2>&1)"
    echo "   Executable: $(python -c 'import sys; print(sys.executable)' 2>&1)"
    echo ""
    
    # Run the CLI and capture exit code
    python -m src.cli.main "$@"
    exit_code=$?
    
    # Exit code 132 = SIGILL (Illegal Instruction) - CPU incompatibility
    if [ $exit_code -eq 132 ]; then
        echo ""
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "‚ùå CPU Compatibility Error (Exit 132: SIGILL)"
        echo ""
        echo "Your CPU doesn't support AVX/AVX2 instructions required by"
        echo "the current packages (numpy 2.x, pyarrow 22.x)."
        echo ""
        echo "FIX: Use older compatible package versions:"
        echo "  rm -rf .venv"
        echo "  ./scripts/setup_no_avx.sh"
        echo "  ./kai"
        echo ""
        echo "This installs numpy 1.24.x and pyarrow 14.0.1 which work"
        echo "on CPUs without AVX support (e.g., Pentium G3258)."
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
    fi
    
    exit $exit_code
fi

# Check if uv is available
if ! command -v uv &> /dev/null; then
    echo "‚ùå Error: 'uv' not found in PATH"
    echo ""
    echo "Install uv with:"
    echo "  curl -LsSf https://astral.sh/uv/install.sh | sh"
    echo ""
    echo "Or create a virtual environment manually:"
    echo "  cd '$SCRIPT_DIR' && python3.11 -m venv .venv && source .venv/bin/activate && pip install -e ."
    exit 1
fi

# Check Ollama is running (suppress errors if pgrep not found)
if command -v pgrep &> /dev/null && ! pgrep -x "ollama" > /dev/null 2>&1; then
    echo "‚ö† Warning: Ollama not running (required for local models)"
    echo "   Start with: ollama serve"
fi

# Try uv run with error handling for CPU compatibility issues
# Force uv to use system Python 3.11 instead of downloading Python 3.12
if ! uv run --directory "$SCRIPT_DIR" --python python3.11 python -m src.cli.main "$@" 2>&1; then
    exit_code=$?
    
    # Exit code 132 = SIGILL (Illegal Instruction) - CPU incompatibility
    if [ $exit_code -eq 132 ]; then
        echo ""
        echo "‚ùå CPU Compatibility Error (Exit 132: SIGILL)"
        echo ""
        echo "The Python binary or packages have CPU incompatibility issues."
        echo ""
        echo "Fix: Create virtual environment with system Python 3.11:"
        echo "  python3.11 -m venv .venv"
        echo "  source .venv/bin/activate"
        echo "  pip install -e ."
        echo "  ./kai"
        echo ""
    fi
    exit $exit_code
fi

# Check Ollama is running (suppress errors if pgrep not found)
if command -v pgrep &> /dev/null && ! pgrep -x "ollama" > /dev/null 2>&1; then
    echo "‚ö† Warning: Ollama not running (required for local models)"
    echo "   Start with: ollama serve"
fi

# Try uv run with error handling for CPU compatibility issues
if ! uv run --directory "$SCRIPT_DIR" python -m src.cli.main "$@" 2>&1; then
    exit_code=$?
    
    # Exit code 132 = SIGILL (Illegal Instruction) - CPU incompatibility
    if [ $exit_code -eq 132 ]; then
        echo ""
        echo "‚ùå CPU Compatibility Error (Exit 132: SIGILL)"
        echo ""
        echo "The Python binary installed by uv is incompatible with your CPU."
        echo ""
        echo "Fix: Create virtual environment with system Python:"
        echo "  python3 -m venv .venv"
        echo "  source .venv/bin/activate"
        echo "  pip install -e ."
        echo "  ./kai"
        echo ""
    fi
    exit $exit_code
fi
